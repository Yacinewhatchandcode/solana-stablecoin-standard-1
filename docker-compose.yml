version: "3.8"

services:
  # â”€â”€ Local Solana Validator â”€â”€
  validator:
    image: solanalabs/solana:v1.18.26
    command: >
      solana-test-validator --reset --quiet --bpf-program SSS111111111111111111111111111111111111111 /workspace/target/deploy/sss.so
    ports:
      - "8899:8899" # RPC
      - "8900:8900" # WebSocket
    volumes:
      - program-data:/workspace/target/deploy
    healthcheck:
      test: [ "CMD", "solana", "cluster-version", "--url", "http://localhost:8899" ]
      interval: 5s
      timeout: 3s
      retries: 10

  # â”€â”€ Build & Test â”€â”€
  sss:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      validator:
        condition: service_healthy
    environment:
      - ANCHOR_PROVIDER_URL=http://validator:8899
      - ANCHOR_WALLET=/root/.config/solana/id.json
    volumes:
      - program-data:/workspace/target/deploy
    command: >
      bash -c "
        echo 'ğŸ”¨ Building SSS Program...'
        anchor build
        echo 'ğŸ§ª Running Tests...'
        anchor test --skip-local-validator --provider.cluster http://validator:8899
        echo 'âœ… All tests passed!'
      "

  # â”€â”€ Deploy to Devnet â”€â”€
  deploy-devnet:
    build:
      context: .
      dockerfile: Dockerfile
    profiles: [ "deploy" ]
    environment:
      - ANCHOR_WALLET=/root/.config/solana/id.json
    command: >
      bash -c "
        echo 'ğŸŒ Deploying to Devnet...'
        solana config set --url devnet
        solana airdrop 2
        anchor build
        anchor deploy --provider.cluster devnet
        echo 'âœ… Deployed to Devnet!'
        solana program show SSS111111111111111111111111111111111111111
      "

volumes:
  program-data:
